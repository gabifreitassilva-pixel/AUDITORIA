<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUDITOR FISCAL PRO | INTELLIGENCE SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.css"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a', /* Azul Profundo */
                        card: '#1e293b',
                        sidebar: '#020617',
                        primary: '#f97316', /* Laranja Maradel */
                        accent: '#3b82f6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255,255,255,0.05); }
        .table-head { position: sticky; top: 0; z-index: 20; background: #1e293b; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        
        /* Badges de Status */
        .status-badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 4px; display: inline-block; min-width: 90px; text-align: center; }
        .status-danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.4); }
        .status-warning { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.4); }
        .status-success { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.4); }
        .status-fixed { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid #3b82f6; } /* Azul para Corrigido */

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
        
        .hidden-tab { display: none !important; }
        
        /* Modal de Lei - Z-Index Alto para garantir que apareça */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1e293b; width: 800px; max-height: 85vh; border-radius: 12px; border: 1px solid #334155; padding: 0; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="flex h-screen w-full">

    <aside class="w-64 bg-sidebar border-r border-slate-800 flex flex-col z-30">
        <div class="px-6 py-8">
            <h1 class="text-xl font-black italic tracking-tighter text-white">AUDITOR<span class="text-primary">.AI</span></h1>
            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Enterprise System</p>
        </div>

        <nav class="space-y-1 flex-1 px-3">
            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-2">Gerencial</p>
            <button onclick="switchTab('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-bold text-white hover:bg-slate-800 transition border-l-2 border-primary bg-slate-900/50">
                <i class="fa-solid fa-chart-pie w-5 text-primary"></i> Dashboard (Vendas)
            </button>

            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-6">Operacional</p>
            <button onclick="switchTab('audit')" class="w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent">
                <i class="fa-solid fa-file-invoice w-5"></i> Auditoria de XML
            </button>
            <button onclick="switchTab('pgdas')" class="w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent">
                <i class="fa-solid fa-scale-unbalanced w-5"></i> Conferência PGDAS
            </button>

            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-6">Base Legal (Consulta)</p>
            <button onclick="switchLibrary('federal')" class="w-full flex items-center gap-3 px-4 py-2 rounded text-xs text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-book w-5"></i> Federal (PIS/COF)</button>
            <button onclick="switchLibrary('st')" class="w-full flex items-center gap-3 px-4 py-2 rounded text-xs text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-industry w-5"></i> Estadual (ST)</button>
            <button onclick="switchLibrary('benefits')" class="w-full flex items-center gap-3 px-4 py-2 rounded text-xs text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-hand-holding-dollar w-5"></i> Benefícios SP</button>
        </nav>
        
        <div class="p-4 bg-slate-950 border-t border-slate-900 text-center">
            <p class="text-[10px] text-slate-500" id="db-status">
                <i class="fa-solid fa-circle-notch fa-spin text-primary"></i> Conectando...
            </p>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-dark">
        <header class="h-16 border-b border-slate-800 bg-card/80 backdrop-blur flex items-center justify-between px-8">
            <div>
                <h2 id="page-title" class="text-lg font-bold text-white">Dashboard</h2>
                <p id="page-subtitle" class="text-[10px] text-slate-400 uppercase tracking-wide">Visão Geral</p>
            </div>
            <div id="audit-actions" class="hidden-tab flex gap-2">
                <input type="file" id="xmlInput" multiple accept=".xml" class="hidden" onchange="handleXmlImport(event)">
                <button onclick="document.getElementById('xmlInput').click()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded text-xs flex items-center gap-2 shadow-lg shadow-indigo-900/20"><i class="fa-solid fa-cloud-arrow-up"></i> IMPORTAR XMLs</button>
                <button onclick="exportReport()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded text-xs flex items-center gap-2 shadow-lg shadow-green-900/20"><i class="fa-solid fa-file-excel"></i> RELATÓRIO</button>
            </div>
        </header>

        <div id="tab-dashboard" class="flex-1 p-8 overflow-auto">
            <div class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 rounded-2xl border border-slate-700 p-8 mb-8 relative overflow-hidden shadow-2xl group">
                <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-primary/5 to-transparent pointer-events-none"></div>
                <div class="relative z-10 flex justify-between items-center">
                    <div class="max-w-3xl">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="bg-primary/20 text-primary border border-primary/30 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider"><i class="fa-solid fa-star mr-1"></i> Inteligência Maradel</span>
                        </div>
                        <h1 class="text-4xl font-black text-white mb-4 leading-tight">Transforme <span class="text-danger decoration-2 underline decoration-danger/30">Erros de Cadastro</span> em <span class="text-success">Caixa Líquido</span>.</h1>
                        <p class="text-slate-400 text-sm leading-relaxed mb-8 border-l-2 border-slate-600 pl-4">A tecnologia da Maradel cruzou seus XMLs com a legislação vigente. Corrija seu cadastro e evite multas enquanto recupera impostos.</p>
                        <div class="flex items-end gap-6">
                            <div>
                                <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Potencial Recuperável</p>
                                <h2 class="text-5xl font-mono font-black text-success tracking-tighter" id="dash-recovery">R$ 0,00</h2>
                            </div>
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end gap-6 pl-8 border-l border-slate-700/50">
                        <button onclick="switchTab('audit')" class="bg-white hover:bg-slate-200 text-dark font-bold py-3 px-6 rounded shadow-xl transition flex items-center gap-3 text-sm uppercase tracking-wide group">
                            Visualizar Correções <i class="fa-solid fa-arrow-right text-primary group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-6">
                <div class="glass-panel p-5 rounded-xl border-l-4 border-slate-500"><p class="text-[10px] uppercase text-slate-400 font-bold">XMLs Processados</p><h3 class="text-3xl font-black text-white mt-1" id="dash-xmls">0</h3></div>
                <div class="glass-panel p-5 rounded-xl border-l-4 border-danger"><p class="text-[10px] uppercase text-slate-400 font-bold">Erros de NCM</p><h3 class="text-3xl font-black text-danger mt-1" id="dash-ncm-errors">0</h3></div>
                <div class="glass-panel p-5 rounded-xl border-l-4 border-warning"><p class="text-[10px] uppercase text-slate-400 font-bold">Divergências CST</p><h3 class="text-3xl font-black text-warning mt-1" id="dash-cst-errors">0</h3></div>
                <div class="glass-panel p-5 rounded-xl border-l-4 border-success"><p class="text-[10px] uppercase text-slate-400 font-bold">Itens Auditados</p><h3 class="text-3xl font-black text-success mt-1" id="dash-products">0</h3></div>
            </div>
        </div>

        <div id="tab-audit" class="flex-1 p-6 hidden-tab flex flex-col overflow-hidden">
            <div class="flex-1 glass-panel rounded-xl border border-slate-700 shadow-2xl flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-800/80 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="font-bold text-sm text-white flex items-center gap-2"><i class="fa-solid fa-robot text-primary"></i> Auditoria Detalhada</h3>
                </div>
                <div class="flex-1 overflow-auto bg-slate-900/50">
                    <table class="w-full text-left text-xs">
                        <thead class="table-head text-slate-300 uppercase font-bold text-[10px]">
                            <tr>
                                <th class="p-4 w-32 text-center">Status</th>
                                <th class="p-4 w-1/4">Produto (XML)</th>
                                <th class="p-4 w-40">Classif. Atual</th>
                                <th class="p-4 text-primary w-1/3">Diagnóstico Legal</th>
                                <th class="p-4 w-40 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="audit-body" class="divide-y divide-slate-800 text-slate-300">
                            <tr><td colspan="5" class="p-20 text-center text-slate-500">Aguardando importação de XML...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-pgdas" class="flex-1 p-8 hidden-tab overflow-auto">
            <div class="max-w-4xl mx-auto glass-panel p-8 rounded-xl border border-slate-700">
                <h2 class="text-xl font-bold text-white mb-6">Conferência PGDAS</h2>
                <div class="grid grid-cols-2 gap-8 mb-8">
                    <div><label class="block text-xs font-bold text-primary mb-2">TOTAL XML</label><div class="text-4xl font-mono font-bold text-white" id="pgdas-xml-val">R$ 0,00</div></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-2">DECLARADO</label><input type="number" id="pgdas-input" class="w-full bg-slate-900 border border-slate-700 text-white text-2xl p-3 rounded focus:border-primary outline-none" placeholder="0.00"></div>
                </div>
                <button onclick="checkPgdas()" class="w-full bg-primary hover:bg-orange-600 text-black font-bold py-3 rounded">AUDITAR</button>
                <div id="pgdas-result" class="mt-6 hidden-tab"></div>
            </div>
        </div>

        <div id="tab-library" class="flex-1 p-6 hidden-tab flex flex-col overflow-hidden">
            <div class="flex gap-4 mb-4 shrink-0 bg-card p-4 rounded-lg border border-slate-700">
                <div class="px-4 py-2 bg-slate-800 rounded text-xs font-bold text-white border border-slate-600" id="lib-badge">BASE</div>
                <input type="text" id="lib-search" onkeyup="filterLibrary()" class="w-full bg-transparent border-none text-white p-2 outline-none" placeholder="Pesquisar lei...">
            </div>
            <div class="flex-1 glass-panel rounded-lg flex flex-col overflow-hidden">
                <div class="flex-1 overflow-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="table-head text-slate-400 uppercase font-bold text-[10px] bg-slate-800" id="lib-thead"></thead>
                        <tbody id="lib-body" class="divide-y divide-slate-700 text-slate-300 font-mono"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="lawModal" class="hidden-tab modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800 rounded-t-lg">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-scale-balanced text-primary"></i> Detalhe da Legislação</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="modalBody" class="p-6 overflow-y-auto text-slate-300 text-sm font-mono whitespace-pre-wrap leading-relaxed"></div>
            <div class="p-4 border-t border-slate-700 bg-slate-800/50 rounded-b-lg text-right">
                <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold rounded">FECHAR</button>
            </div>
        </div>
    </div>

    <script>
        // ==================================================================================
        // CARREGAMENTO DINÂMICO
        // ==================================================================================
        let DB_FEDERAL = [], DB_ST = [], DB_BENEFITS = [];
        const FILE_PIS = "lei_federal.html";
        const FILE_ST = "lei_estadual.html"; 
        const FILE_BENEFITS = "lei_beneficios.html";

        async function loadExternalData() {
            try {
                const [r1, r2, r3] = await Promise.all([fetch(FILE_PIS), fetch(FILE_ST), fetch(FILE_BENEFITS)]);
                if(r1.ok) DB_FEDERAL = parseTableData(await r1.text(), 'federal');
                if(r2.ok) DB_ST = parseTableData(await r2.text(), 'st');
                if(r3.ok) DB_BENEFITS = parseTableData(await r3.text(), 'benefits');
                
                const total = DB_FEDERAL.length + DB_ST.length + DB_BENEFITS.length;
                document.getElementById('db-status').innerHTML = `<i class="fa-solid fa-check text-green-500"></i> ${total.toLocaleString()} regras carregadas.`;
                document.getElementById('db-status').className = "text-[10px] text-green-500 font-bold";
            } catch (error) {
                console.error("Erro:", error);
                document.getElementById('db-status').innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i> Erro ao ler base de dados.`;
            }
        }

        function parseTableData(htmlText, type) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const rows = doc.querySelectorAll('tbody tr');
            const data = [];
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length > 0) {
                    const rowData = [];
                    cols.forEach(col => rowData.push(col.textContent.trim()));
                    if(type === 'federal' && rowData.length >= 4) data.push(rowData);
                    else if(rowData.length >= 6) data.push(rowData);
                }
            });
            return data;
        }
        window.addEventListener('load', loadExternalData);

        // ==================================================================================
        // ENGINE DE AUDITORIA
        // ==================================================================================
        let xmlItems = [];
        let activeLibrary = 'federal';

        function handleXmlImport(event) {
            const files = event.target.files;
            if (!files.length) return;
            xmlItems = [];
            document.getElementById('audit-body').innerHTML = `<tr><td colspan="5" class="p-12 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin text-3xl mb-4 text-primary"></i><p>Processando inteligência fiscal...</p></td></tr>`;

            setTimeout(() => {
                let processed = 0;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(e.target.result, "text/xml");
                        const dets = xml.getElementsByTagName("det");
                        for (let det of dets) {
                            const prod = det.getElementsByTagName("prod")[0];
                            const imposto = det.getElementsByTagName("imposto")[0];
                            const item = {
                                xProd: prod.getElementsByTagName("xProd")[0]?.textContent || "SEM NOME",
                                ncm: prod.getElementsByTagName("NCM")[0]?.textContent || "00000000",
                                vProd: parseFloat(prod.getElementsByTagName("vProd")[0]?.textContent || 0),
                                cst: getTagValue(imposto, ["CST", "CSOSN"]),
                            };
                            auditItem(item);
                        }
                        processed++;
                        if(processed === files.length) { updateDashboard(); switchTab('audit'); }
                    };
                    reader.readAsText(file);
                });
            }, 800);
        }

        function getTagValue(parent, tagNames) {
            if(!parent) return "00";
            for (let tag of tagNames) {
                const els = parent.getElementsByTagName(tag);
                if (els.length > 0) return els[0].textContent;
            }
            return "00"; 
        }

        function auditItem(item) {
            item.status = 'ok';
            item.analysis = [];
            item.tag = '';
            item.potentialRecovery = 0;
            item.ncmError = false;
            
            const ncmClean = item.ncm.replace(/\./g, '').trim(); 
            const descClean = item.xProd.toUpperCase();

            // 1. INTELIGÊNCIA DE NCM (TEXTO)
            let identifiedProduct = identifyProductByText(descClean);
            let ncmToAudit = ncmClean;

            if (identifiedProduct && !ncmClean.startsWith(identifiedProduct.ncm.replace(/\./g,''))) {
                item.status = 'error'; item.tag = 'CLASSIFICAÇÃO'; item.ncmError = true;
                item.analysis.push(`<span class="text-danger font-bold"><i class="fa-solid fa-triangle-exclamation"></i> ERRO DE NCM</span><br>Item identificado como "<b>${identifiedProduct.desc}</b>" (NCM ${identifiedProduct.ncm}), mas XML traz ${item.ncm}.<br>A regra correta será aplicada sobre o NCM ${identifiedProduct.ncm}.`);
                ncmToAudit = identifiedProduct.ncm.replace(/\./g,''); 
            } else if (ncmClean === "00000000" || ncmClean.length < 4) {
                if (identifiedProduct) {
                    item.status = 'error'; item.tag = 'CADASTRO';
                    item.analysis.push(`<span class="text-warning font-bold">NCM RECUPERADO:</span> Match por descrição: ${identifiedProduct.desc} (${identifiedProduct.ncm}).`);
                    ncmToAudit = identifiedProduct.ncm.replace(/\./g,'');
                } else {
                    item.status = 'error'; item.tag = 'CRÍTICO';
                    item.analysis.push(`<span class="text-danger font-bold">NCM INVÁLIDO:</span> Descrição não encontrada na base.`);
                    xmlItems.push(item);
                    return;
                }
            }

            // 2. AUDITORIA TRIBUTÁRIA
            const fedMatch = DB_FEDERAL.find(row => ncmToAudit.startsWith(row[1].replace(/\./g,'')));
            if (fedMatch) {
                const cstEsperado = fedMatch[0]; 
                if (item.cst !== cstEsperado) {
                    if(!item.ncmError) { item.status = 'error'; item.tag = 'PIS/COFINS'; }
                    item.analysis.push(`<span class="text-primary font-bold">Divergência PIS/COFINS:</span> Lei prevê CST ${cstEsperado}. Encontrado ${item.cst}.<br><span class="text-[10px] text-slate-500">${fedMatch[3]}</span>`);
                    item.newCst = cstEsperado;
                    if(item.cst === '01' || item.cst === '49') item.potentialRecovery = item.vProd * 0.0365;
                }
            }

            const stMatch = DB_ST.find(row => ncmToAudit.startsWith(row[3].replace(/\./g,'')));
            if (stMatch) {
                const cstST = ['10', '30', '60', '70', '201', '202', '203', '500'];
                if (!cstST.includes(item.cst)) {
                     if(item.status !== 'error') { item.status = 'warning'; item.tag = 'ICMS-ST'; }
                     item.analysis.push(`<span class="text-accent font-bold">Alerta ST:</span> Produto ST (${stMatch[4]}). XML sem destaque.`);
                }
            }

            if (!stMatch) {
                const benMatch = DB_BENEFITS.find(row => ncmToAudit.startsWith(row[2].replace(/\./g,'')));
                if (benMatch && item.status === 'ok') {
                    item.status = 'success'; item.tag = 'BENEFÍCIO';
                    item.analysis.push(`<span class="text-success font-bold">Oportunidade:</span> ${benMatch[0]} disponível (${benMatch[4]}).`);
                }
            }

            xmlItems.push(item);
        }

        function identifyProductByText(desc) {
            if (!desc) return null;
            const cleanDesc = desc.toUpperCase();
            // Varre ST
            for (let row of DB_ST) {
                if (!row[4]) continue; 
                const keywords = row[4].toUpperCase().split(' ').filter(w => w.length > 3 && !['PARA', 'QUALQUER'].includes(w));
                if (keywords.some(k => cleanDesc.includes(k))) return { ncm: row[3], desc: row[4] };
                if (cleanDesc.includes("PICOLE") && row[4].toUpperCase().includes("SORVETE")) return { ncm: "2105", desc: "Sorvetes e Picolés" };
            }
            // Varre Federal
            for (let row of DB_FEDERAL) {
                if (!row[2]) continue;
                if(row[2].toUpperCase().includes("REFRIGERANTE") && cleanDesc.includes("REFRIGERANTE")) return { ncm: row[1], desc: row[2] };
            }
            return null;
        }

        // --- FUNÇÃO DE CORREÇÃO (BOTÃO) ---
        function applyFix(btn, index) {
            const item = xmlItems[index];
            item.status = 'fixed'; // Novo status visual
            
            // Atualiza visualmente a linha
            const row = btn.closest('tr');
            row.classList.remove('hover:bg-slate-800');
            row.classList.add('bg-success/10');
            
            // Atualiza Badge
            row.querySelectorAll('td')[0].innerHTML = '<span class="status-badge status-fixed">CORRIGIDO</span>';
            
            // Atualiza Botão
            const cellAction = row.querySelectorAll('td')[4];
            cellAction.innerHTML = `<span class="text-success text-xs font-bold flex items-center justify-center gap-1"><i class="fa-solid fa-check-circle"></i> Feito</span>`;
            
            // Atualiza Dashboard Financeiro (Visual)
            const recEl = document.getElementById('dash-recovery');
            recEl.classList.add('text-white');
            setTimeout(() => recEl.classList.remove('text-white'), 300);
        }

        // --- UI RENDER ---
        function updateDashboard() {
            document.getElementById('dash-xmls').innerText = "1"; 
            document.getElementById('dash-products').innerText = xmlItems.length.toLocaleString();
            document.getElementById('dash-ncm-errors').innerText = xmlItems.filter(i => i.ncmError).length;
            document.getElementById('dash-cst-errors').innerText = xmlItems.filter(i => i.status === 'error' && !i.ncmError).length;
            
            const recovery = xmlItems.reduce((acc, i) => acc + i.potentialRecovery, 0);
            document.getElementById('dash-recovery').innerText = recovery.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            const tbody = document.getElementById('audit-body');
            tbody.innerHTML = '';
            
            xmlItems.slice(0, 200).forEach((item, index) => {
                // STATUS E MENSAGENS EM VERDE SE OK
                let badge = '<span class="status-badge bg-slate-700 text-slate-400">OK</span>';
                let message = '<span class="text-success italic font-bold flex items-center gap-2"><i class="fa-solid fa-check-circle"></i> Conforme Lei</span>';
                let actionBtn = '-';

                if (item.ncmError) {
                    badge = '<span class="status-badge status-danger">ERRO NCM</span>';
                    message = item.analysis.join('<br>');
                    actionBtn = `<button onclick="applyFix(this, ${index})" class="bg-primary hover:bg-orange-600 text-black px-3 py-1.5 rounded text-[10px] font-bold uppercase shadow-lg shadow-orange-900/20 transition w-full flex items-center justify-center gap-1"><i class="fa-solid fa-wrench"></i> Corrigir NCM</button>`;
                }
                else if (item.status === 'error') {
                    badge = '<span class="status-badge status-danger">RISCO</span>';
                    message = item.analysis.join('<br>');
                    actionBtn = `<button onclick="applyFix(this, ${index})" class="bg-primary hover:bg-orange-600 text-black px-3 py-1.5 rounded text-[10px] font-bold uppercase shadow-lg shadow-orange-900/20 transition w-full flex items-center justify-center gap-1"><i class="fa-solid fa-wrench"></i> Corrigir CST</button>`;
                }
                else if (item.status === 'warning') {
                    badge = '<span class="status-badge status-warning">ALERTA</span>';
                    message = item.analysis.join('<br>');
                    actionBtn = `<button onclick="applyFix(this, ${index})" class="bg-accent/20 text-accent border border-accent hover:bg-accent hover:text-white px-3 py-1.5 rounded text-[10px] font-bold uppercase transition w-full">Revisar</button>`;
                }

                const row = document.createElement('tr');
                row.className = "hover:bg-slate-800 border-b border-slate-700/50 transition";
                row.innerHTML = `
                    <td class="p-4 text-center align-top">${badge}</td>
                    <td class="p-4 align-top">
                        <div class="font-bold text-white text-xs">${item.xProd}</div>
                        <div class="text-[9px] text-slate-500 mt-1">R$ ${item.vProd.toFixed(2)}</div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] ${item.ncmError ? 'text-danger font-bold' : 'text-slate-400'} bg-slate-900 px-2 py-1 rounded w-fit font-mono">NCM: ${item.ncm}</span>
                            <span class="text-[10px] text-slate-400 bg-slate-900 px-2 py-1 rounded w-fit font-mono">CST: ${item.cst}</span>
                        </div>
                    </td>
                    <td class="p-4 text-xs leading-relaxed align-top">
                        ${message}
                    </td>
                    <td class="p-4 text-center align-top">
                        ${actionBtn}
                    </td>
                `;
                tbody.appendChild(row);
            });

            const total = xmlItems.reduce((acc, i) => acc + i.vProd, 0);
            document.getElementById('pgdas-xml-val').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('pgdas-xml-val').dataset.val = total;
        }

        // --- NAVEGAÇÃO ---
        function switchTab(tabId) {
            ['dashboard', 'audit', 'pgdas', 'library'].forEach(id => document.getElementById('tab-' + id).classList.add('hidden-tab'));
            document.getElementById('tab-' + tabId).classList.remove('hidden-tab');
            const actions = document.getElementById('audit-actions');
            const title = document.getElementById('page-title');
            const sub = document.getElementById('page-subtitle');

            if(tabId === 'audit') {
                actions.classList.remove('hidden-tab');
                title.innerText = 'Auditoria de XML';
                sub.innerText = 'Análise item a item com Inteligência Artificial';
            } else if (tabId === 'dashboard') {
                actions.classList.add('hidden-tab');
                title.innerText = 'Dashboard Gerencial';
                sub.innerText = 'Visão consolidada de riscos e oportunidades';
            } else if (tabId === 'pgdas') {
                actions.classList.add('hidden-tab');
                title.innerText = 'Conferência PGDAS';
                sub.innerText = 'Cruzamento de obrigações acessórias';
            } else {
                actions.classList.add('hidden-tab');
                title.innerText = 'Base Legal Integrada';
                sub.innerText = 'Consulta direta à legislação tributária';
            }
        }

        function switchLibrary(type) {
            switchTab('library');
            activeLibrary = type;
            const badge = document.getElementById('lib-badge');
            badge.innerText = type === 'federal' ? 'FEDERAL' : (type === 'st' ? 'ESTADUAL ST' : 'BENEFÍCIOS SP');
            badge.className = `bg-slate-800 px-4 py-2 rounded text-xs font-bold text-white border flex items-center uppercase ${type === 'federal' ? 'border-primary text-primary' : (type === 'st' ? 'border-accent text-accent' : 'border-success text-success')}`;
            filterLibrary();
        }

        function filterLibrary() {
            const term = document.getElementById('lib-search').value.toLowerCase();
            const tbody = document.getElementById('lib-body');
            tbody.innerHTML = '';
            
            let source = activeLibrary === 'federal' ? DB_FEDERAL : (activeLibrary === 'st' ? DB_ST : DB_BENEFITS);
            let filtered = source.filter(row => row.some(c => c && c.toLowerCase().includes(term)));
            if(term === '') filtered = filtered.slice(0, 100);

            filtered.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800 border-b border-slate-700/50 cursor-pointer transition";
                
                // Evento de clique para abrir modal
                tr.onclick = () => openLawModal(row);

                if (activeLibrary === 'federal') {
                    tr.innerHTML = `<td class="p-3 text-primary font-bold">${row[0]}</td><td class="p-3 font-mono text-white">${row[1]}</td><td class="p-3 text-slate-300">${row[2]}</td><td class="p-3 text-slate-500 text-[10px] uppercase font-bold hover:text-white"><i class="fa-solid fa-book-open mr-1"></i> ${row[3]}</td>`;
                } else if (activeLibrary === 'st') {
                    tr.innerHTML = `<td class="p-3 font-bold text-slate-500">${row[0]}</td><td class="p-3 font-mono text-slate-400">${row[1]}</td><td class="p-3 font-mono text-white">${row[3]}</td><td class="p-3 text-slate-300 text-[11px]">${row[4]}</td><td class="p-3"><span class="bg-slate-700 text-slate-300 px-2 py-1 rounded text-[9px] font-bold border border-slate-600">${row[5]}</span></td>`;
                } else {
                    tr.innerHTML = `<td class="p-3 font-bold text-success">${row[0]}</td><td class="p-3 text-white">${row[1]}</td><td class="p-3 font-mono text-slate-300">${row[2]}</td><td class="p-3 text-slate-300 text-[11px]">${row[3]}</td><td class="p-3 text-slate-500 text-[10px] uppercase hover:text-white"><i class="fa-solid fa-file-contract mr-1"></i> ${row[4]}</td>`;
                }
                tbody.appendChild(tr);
            });
        }

        // --- MODAL DE LEI ---
        function openLawModal(row) {
            const modal = document.getElementById('lawModal');
            const body = document.getElementById('modalBody');
            modal.classList.remove('hidden-tab');
            
            // Pega o fundamento legal (última coluna geralmente)
            const fundamento = row[row.length - 1];
            const descricao = activeLibrary === 'st' ? row[4] : row[2];
            const ncm = activeLibrary === 'st' ? row[3] : row[1];

            body.innerHTML = `
                <div class="mb-6 p-4 bg-black/40 rounded border border-slate-700">
                    <h2 class="text-primary font-bold text-xl mb-2">${descricao}</h2>
                    <div class="flex gap-4 text-xs">
                        <span class="text-white bg-slate-700 px-2 py-1 rounded">NCM: ${ncm}</span>
                        <span class="text-white bg-slate-700 px-2 py-1 rounded">CST Ref: ${row[0]}</span>
                    </div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-white font-bold border-b border-slate-700 pb-2">Dispositivo Legal:</h4>
                    <p class="text-justify text-slate-400">${fundamento}</p>
                    <p class="text-justify text-slate-500 text-xs italic mt-4">
                        * Este produto consta na base de dados oficial carregada no sistema. A tributação deve seguir rigorosamente a classificação indicada para evitar autuações fiscais ou recolhimento indevido.
                    </p>
                </div>
            `;
        }
        function closeModal() { document.getElementById('lawModal').classList.add('hidden-tab'); }

        // --- PGDAS ---
        function checkPgdas() {
            const xml = parseFloat(document.getElementById('pgdas-xml-val').dataset.val || 0);
            const user = parseFloat(document.getElementById('pgdas-input').value || 0);
            const diff = xml - user;
            const res = document.getElementById('pgdas-result');
            res.classList.remove('hidden-tab');
            if(diff > 0.01) res.innerHTML = `<div class="bg-danger/10 border-l-4 border-danger p-6 rounded-r text-white shadow-lg"><h3 class="font-bold text-lg mb-2"><i class="fa-solid fa-triangle-exclamation mr-2"></i>DIVERGÊNCIA ENCONTRADA</h3><p>O valor emitido em notas (XML) é superior ao declarado no PGDAS.</p><div class="mt-4 p-3 bg-black/40 rounded border border-danger/30 inline-block"><span class="text-xs text-danger uppercase font-bold">Valor a Declarar (Diferença):</span><br><span class="text-2xl font-mono">R$ ${diff.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div></div>`;
            else res.innerHTML = `<div class="bg-success/10 border-l-4 border-success p-6 rounded-r text-white shadow-lg"><h3 class="font-bold text-lg mb-2"><i class="fa-solid fa-check-circle mr-2"></i>CONFORMIDADE TOTAL</h3><p>Os valores declarados conferem com a emissão de notas fiscais.</p></div>`;
        }

        function exportReport() {
            if(xmlItems.length === 0) return alert("Nada para exportar");
            const data = xmlItems.map(i => ({Produto: i.xProd, NCM: i.ncm, Valor: i.vProd, CST: i.cst, Status: i.status, Diagnostico: i.analysis.join(' | ').replace(/<[^>]*>/g, '')}));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Auditoria");
            XLSX.writeFile(wb, "Relatorio_Auditor.xlsx");
        }

        // Init
        switchTab('dashboard');
    </script>
</body>
</html>
