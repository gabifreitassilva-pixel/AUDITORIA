<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUDITOR FISCAL PRO | INTELLIGENCE SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.css"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        sidebar: '#020617',
                        primary: '#f97316', 
                        accent: '#3b82f6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255,255,255,0.05); }
        .table-head { position: sticky; top: 0; z-index: 20; background: #1e293b; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .status-badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 4px; display: inline-block; min-width: 90px; text-align: center; }
        .status-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.4); }
        .status-warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.4); }
        .status-success { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.4); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
        .hidden-tab { display: none !important; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body class="flex h-screen w-full">

    <aside class="w-64 bg-sidebar border-r border-slate-800 flex flex-col z-30">
        <div class="px-6 py-8">
            <h1 class="text-xl font-black italic tracking-tighter text-white">AUDITOR<span class="text-primary">.AI</span></h1>
            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Conectado ao Repositório</p>
        </div>

        <nav class="space-y-1 flex-1 px-3">
            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-2">Gerencial</p>
            <button onclick="switchTab('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-bold text-white hover:bg-slate-800 transition border-l-2 border-primary bg-slate-900/50">
                <i class="fa-solid fa-chart-pie w-5 text-primary"></i> Dashboard
            </button>

            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-6">Operacional</p>
            <button onclick="switchTab('audit')" class="w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent">
                <i class="fa-solid fa-file-invoice w-5"></i> Auditoria de XML
            </button>
            <button onclick="switchTab('pgdas')" class="w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent">
                <i class="fa-solid fa-scale-unbalanced w-5"></i> Conferência PGDAS
            </button>

            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-6">Visualizar Leis</p>
            <button onclick="switchLibrary('federal')" class="w-full flex items-center gap-3 px-4 py-2 rounded text-xs text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-book w-5"></i> Federal (PIS/COF)</button>
            <button onclick="switchLibrary('st')" class="w-full flex items-center gap-3 px-4 py-2 rounded text-xs text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-industry w-5"></i> Estadual (ST)</button>
            <button onclick="switchLibrary('benefits')" class="w-full flex items-center gap-3 px-4 py-2 rounded text-xs text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-hand-holding-dollar w-5"></i> Benefícios SP</button>
        </nav>
        
        <div class="p-4 bg-slate-950 border-t border-slate-900 text-center">
            <p class="text-[10px] text-slate-500" id="db-status">
                <i class="fa-solid fa-circle-notch fa-spin text-primary"></i> Conectando aos arquivos...
            </p>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-dark">
        <header class="h-16 border-b border-slate-800 bg-card/80 backdrop-blur flex items-center justify-between px-8">
            <div>
                <h2 id="page-title" class="text-lg font-bold text-white">Dashboard</h2>
                <p id="page-subtitle" class="text-[10px] text-slate-400 uppercase tracking-wide">Visão Geral</p>
            </div>
            <div id="audit-actions" class="hidden-tab flex gap-2">
                <input type="file" id="xmlInput" multiple accept=".xml" class="hidden" onchange="handleXmlImport(event)">
                <button onclick="document.getElementById('xmlInput').click()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded text-xs flex items-center gap-2 shadow-lg shadow-indigo-900/20"><i class="fa-solid fa-cloud-arrow-up"></i> IMPORTAR XMLs</button>
                <button onclick="exportReport()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded text-xs flex items-center gap-2 shadow-lg shadow-green-900/20"><i class="fa-solid fa-file-excel"></i> RELATÓRIO</button>
            </div>
        </header>

        <div id="tab-dashboard" class="flex-1 p-8 overflow-auto">
            <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl border border-slate-700 p-8 mb-8 relative overflow-hidden shadow-2xl">
                <div class="relative z-10 flex justify-between items-center">
                    <div>
                        <h3 class="text-slate-400 text-sm font-bold uppercase tracking-widest mb-2">Potencial de Recuperação</h3>
                        <h1 class="text-5xl font-black text-white mb-2" id="dash-recovery">R$ 0,00</h1>
                        <p class="text-success text-sm font-bold flex items-center gap-2"><i class="fa-solid fa-arrow-trend-up"></i> Pagamento Indevido Identificado</p>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-6">
                <div class="glass-panel p-5 rounded-xl border-l-4 border-danger">
                    <p class="text-[10px] uppercase text-slate-400 font-bold">Erros de NCM</p>
                    <h3 class="text-3xl font-black text-danger mt-1" id="dash-ncm-errors">0</h3>
                    <p class="text-[10px] text-slate-500">Produtos com NCM Zerado/Incorreto</p>
                </div>
                <div class="glass-panel p-5 rounded-xl border-l-4 border-warning">
                    <p class="text-[10px] uppercase text-slate-400 font-bold">Divergências</p>
                    <h3 class="text-3xl font-black text-warning mt-1" id="dash-cst-errors">0</h3>
                    <p class="text-[10px] text-slate-500">CST diferente da Lei</p>
                </div>
                <div class="glass-panel p-5 rounded-xl border-l-4 border-primary">
                    <p class="text-[10px] uppercase text-slate-400 font-bold">Itens Auditados</p>
                    <h3 class="text-3xl font-black text-primary mt-1" id="dash-products">0</h3>
                </div>
                <div class="glass-panel p-5 rounded-xl border-l-4 border-success">
                    <p class="text-[10px] uppercase text-slate-400 font-bold">XMLs</p>
                    <h3 class="text-3xl font-black text-white mt-1" id="dash-xmls">0</h3>
                </div>
            </div>
        </div>

        <div id="tab-audit" class="flex-1 p-6 hidden-tab flex flex-col overflow-hidden">
            <div class="flex-1 glass-panel rounded-xl border border-slate-700 shadow-2xl flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-800/80 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="font-bold text-sm text-white flex items-center gap-2"><i class="fa-solid fa-robot text-primary"></i> Resultado da Auditoria (Cruzamento Descrição x NCM)</h3>
                </div>
                <div class="flex-1 overflow-auto bg-slate-900/50">
                    <table class="w-full text-left text-xs">
                        <thead class="table-head text-slate-300 uppercase font-bold text-[10px]">
                            <tr>
                                <th class="p-4 w-32 text-center">Status</th>
                                <th class="p-4 w-1/4">Produto (XML)</th>
                                <th class="p-4 w-40">Classif. Atual</th>
                                <th class="p-4 text-primary w-1/3">Inteligência Fiscal (Lei)</th>
                                <th class="p-4 w-40 text-center">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="audit-body" class="divide-y divide-slate-800 text-slate-300">
                            <tr><td colspan="5" class="p-20 text-center text-slate-500">Importe os arquivos para começar.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-pgdas" class="flex-1 p-8 hidden-tab overflow-auto">
            <div class="max-w-4xl mx-auto glass-panel p-8 rounded-xl border border-slate-700">
                <h2 class="text-xl font-bold text-white mb-6">Conferência PGDAS</h2>
                <div class="grid grid-cols-2 gap-8 mb-8">
                    <div>
                        <label class="block text-xs font-bold text-primary mb-2">TOTAL XML</label>
                        <div class="text-4xl font-mono font-bold text-white" id="pgdas-xml-val">R$ 0,00</div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">DECLARADO</label>
                        <input type="number" id="pgdas-input" class="w-full bg-slate-900 border border-slate-700 text-white text-2xl p-3 rounded focus:border-primary outline-none" placeholder="0.00">
                    </div>
                </div>
                <button onclick="checkPgdas()" class="w-full bg-primary hover:bg-orange-600 text-black font-bold py-3 rounded">AUDITAR</button>
                <div id="pgdas-result" class="mt-6 hidden-tab"></div>
            </div>
        </div>

        <div id="tab-library" class="flex-1 p-6 hidden-tab flex flex-col overflow-hidden">
            <div class="flex gap-4 mb-4 shrink-0 bg-card p-4 rounded-lg border border-slate-700">
                <div class="px-4 py-2 bg-slate-800 rounded text-xs font-bold text-white border border-slate-600" id="lib-badge">BASE</div>
                <input type="text" id="lib-search" onkeyup="filterLibrary()" class="w-full bg-transparent border-none text-white p-2 outline-none" placeholder="Pesquisar...">
            </div>
            <div class="flex-1 glass-panel rounded-lg flex flex-col overflow-hidden">
                <div class="flex-1 overflow-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="table-head text-slate-400 uppercase font-bold text-[10px] bg-slate-800" id="lib-thead"></thead>
                        <tbody id="lib-body" class="divide-y divide-slate-700 text-slate-300 font-mono"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="lawModal" class="hidden-tab modal-bg"><div class="bg-card border border-slate-600 rounded-lg p-6 w-3/4 max-h-[80vh] overflow-auto"><div class="flex justify-between mb-4"><h3 class="text-xl font-bold text-white">Texto Legal</h3><button onclick="closeModal()" class="text-white"><i class="fa-solid fa-xmark"></i></button></div><div id="modalBody" class="text-slate-300 font-mono text-sm"></div></div></div>

    <script>
        // ==================================================================================
        // 1. CARREGAMENTO DINÂMICO DOS ARQUIVOS DO REPOSITÓRIO
        // ==================================================================================
        
        let DB_FEDERAL = [];
        let DB_ST = [];
        let DB_BENEFITS = [];

        // NOMES EXATOS DOS ARQUIVOS (CONFIRA SE ESTÁ IGUAL NO REPOSITÓRIO)
        const FILE_PIS = "lei_federal.html";
        const FILE_ST = "lei_estadual.html"; 
        const FILE_BENEFITS = "lei_beneficios.html";

        async function loadExternalData() {
            try {
                // Carrega PIS COFINS
                const pisResponse = await fetch(FILE_PIS);
                if(pisResponse.ok) {
                    const text = await pisResponse.text();
                    DB_FEDERAL = parseTableData(text, 'federal');
                }

                // Carrega ST
                const stResponse = await fetch(FILE_ST);
                if(stResponse.ok) {
                    const text = await stResponse.text();
                    DB_ST = parseTableData(text, 'st');
                }

                // Carrega Benefícios
                const benResponse = await fetch(FILE_BENEFITS);
                if(benResponse.ok) {
                    const text = await benResponse.text();
                    DB_BENEFITS = parseTableData(text, 'benefits');
                }

                // Atualiza Status
                const total = DB_FEDERAL.length + DB_ST.length + DB_BENEFITS.length;
                const statusEl = document.getElementById('db-status');
                statusEl.innerHTML = `<i class="fa-solid fa-check text-green-500"></i> ${total.toLocaleString()} regras carregadas.`;
                statusEl.className = "text-[10px] text-green-500 font-bold";

            } catch (error) {
                console.error("Erro ao carregar arquivos:", error);
                document.getElementById('db-status').innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i> Erro ao ler arquivos.`;
            }
        }

        // Função para ler o HTML dos arquivos e transformar em Array
        function parseTableData(htmlText, type) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const rows = doc.querySelectorAll('tbody tr');
            const data = [];

            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length > 0) {
                    const rowData = [];
                    cols.forEach(col => rowData.push(col.textContent.trim()));
                    
                    // Tratamento específico se necessário para alinhar com a lógica do auditor
                    if(type === 'federal') {
                        // Esperado: [CST, NCM, DESC, LEI]
                        // Se o arquivo tiver outra ordem, ajustamos aqui. 
                        // Assumindo ordem do arquivo: CST, NCM, DESC, FUNDAMENTO
                        if(rowData.length >= 4) data.push(rowData);
                    } else if (type === 'st') {
                        // Esperado: [ANEXO, ITEM, CEST, NCM, DESC, STATUS]
                        if(rowData.length >= 6) data.push(rowData);
                    } else {
                        // Beneficios: [TIPO, CST, NCM, DESC, REGRA, LEI]
                        if(rowData.length >= 6) data.push(rowData);
                    }
                }
            });
            return data;
        }

        // Inicializa carregamento
        window.addEventListener('load', loadExternalData);


        // ==================================================================================
        // 2. ENGINE DE INTELIGÊNCIA (AUDITORIA HÍBRIDA)
        // ==================================================================================

        let xmlItems = [];
        let activeLibrary = 'federal';

        function handleXmlImport(event) {
            const files = event.target.files;
            if (!files.length) return;
            xmlItems = [];
            document.getElementById('audit-body').innerHTML = `<tr><td colspan="5" class="p-12 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin text-3xl mb-4 text-primary"></i><p>Analisando NCMs e Descrições...</p></td></tr>`;

            setTimeout(() => {
                let processed = 0;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(e.target.result, "text/xml");
                        const dets = xml.getElementsByTagName("det");
                        for (let det of dets) {
                            const prod = det.getElementsByTagName("prod")[0];
                            const imposto = det.getElementsByTagName("imposto")[0];
                            const item = {
                                xProd: prod.getElementsByTagName("xProd")[0]?.textContent || "SEM NOME",
                                ncm: prod.getElementsByTagName("NCM")[0]?.textContent || "00000000",
                                vProd: parseFloat(prod.getElementsByTagName("vProd")[0]?.textContent || 0),
                                cst: getTagValue(imposto, ["CST", "CSOSN"]),
                            };
                            auditItem(item);
                        }
                        processed++;
                        if(processed === files.length) { updateDashboard(); switchTab('audit'); }
                    };
                    reader.readAsText(file);
                });
            }, 800);
        }

        function getTagValue(parent, tagNames) {
            if(!parent) return "00";
            for (let tag of tagNames) {
                const els = parent.getElementsByTagName(tag);
                if (els.length > 0) return els[0].textContent;
            }
            return "00"; 
        }

        function auditItem(item) {
            item.status = 'ok';
            item.analysis = [];
            item.tag = '';
            item.potentialRecovery = 0;
            item.ncmError = false;
            
            const ncmClean = item.ncm.replace(/\./g, '').trim(); 
            const descClean = item.xProd.toUpperCase();

            // PASSO 1: IDENTIFICAR PRODUTO PELO TEXTO (Se NCM estiver errado)
            let identifiedProduct = identifyProductByText(descClean);
            let ncmToAudit = ncmClean;

            // Se achou pelo nome e o NCM do XML não bate
            if (identifiedProduct && !ncmClean.startsWith(identifiedProduct.ncm.replace(/\./g,''))) {
                item.status = 'error';
                item.tag = 'CLASSIFICAÇÃO';
                item.ncmError = true;
                item.analysis.push(`<span class="text-danger font-bold"><i class="fa-solid fa-triangle-exclamation"></i> ERRO DE NCM</span><br>Produto identificado como "<b>${identifiedProduct.desc}</b>" (NCM ${identifiedProduct.ncm}), mas XML traz ${item.ncm}.<br>A regra correta será aplicada sobre o NCM ${identifiedProduct.ncm}.`);
                ncmToAudit = identifiedProduct.ncm.replace(/\./g,''); 
            } else if (ncmClean === "00000000" || ncmClean.length < 4) {
                if (identifiedProduct) {
                    item.status = 'error'; item.tag = 'CADASTRO';
                    item.analysis.push(`<span class="text-warning font-bold">NCM RECUPERADO:</span> Encontrado via descrição: ${identifiedProduct.desc} (${identifiedProduct.ncm}).`);
                    ncmToAudit = identifiedProduct.ncm.replace(/\./g,'');
                } else {
                    item.status = 'error'; item.tag = 'CRÍTICO';
                    item.analysis.push(`<span class="text-danger font-bold">NCM INVÁLIDO:</span> Corrigir cadastro.`);
                    xmlItems.push(item);
                    return;
                }
            }

            // PASSO 2: AUDITORIA TRIBUTÁRIA
            
            // Federal (PIS/COFINS)
            // Acessa indices baseados no parse do arquivo PIS COFINS.HTML
            const fedMatch = DB_FEDERAL.find(row => ncmToAudit.startsWith(row[1].replace(/\./g,'')));
            if (fedMatch) {
                const cstEsperado = fedMatch[0]; 
                if (item.cst !== cstEsperado) {
                    if(!item.ncmError) { item.status = 'error'; item.tag = 'PIS/COFINS'; }
                    item.analysis.push(`<span class="text-primary font-bold">Divergência PIS/COFINS:</span> Lei Federal indica CST ${cstEsperado}. Encontrado ${item.cst}.<br><span class="text-[10px] text-slate-500">${fedMatch[3]}</span>`);
                    item.newCst = cstEsperado;
                    if(item.cst === '01' || item.cst === '49') item.potentialRecovery = item.vProd * 0.0365;
                }
            }

            // Estadual ST
            // Acessa indices baseados no parse do arquivo CONVENIO...HTML
            // NCM no ST geralmente é indice 3 (verificar parseTableData)
            const stMatch = DB_ST.find(row => ncmToAudit.startsWith(row[3].replace(/\./g,'')));
            if (stMatch) {
                const cstST = ['10', '30', '60', '70', '201', '202', '203', '500'];
                if (!cstST.includes(item.cst)) {
                     if(item.status !== 'error') { item.status = 'warning'; item.tag = 'ICMS-ST'; }
                     item.analysis.push(`<span class="text-accent font-bold">Alerta ST:</span> Produto ST (${stMatch[4]}). XML sem destaque.`);
                }
            }

            // Benefícios
            // NCM no Beneficio geralmente é indice 2
            if (!stMatch) {
                const benMatch = DB_BENEFITS.find(row => ncmToAudit.startsWith(row[2].replace(/\./g,'')));
                if (benMatch && item.status === 'ok') {
                    item.status = 'success'; item.tag = 'BENEFÍCIO';
                    item.analysis.push(`<span class="text-success font-bold">Oportunidade:</span> ${benMatch[0]} disponível (${benMatch[4]}).`);
                }
            }

            xmlItems.push(item);
        }

        // --- INTELLIGENCE (TEXTO -> NCM) ---
        function identifyProductByText(desc) {
            if (!desc) return null;
            const cleanDesc = desc.toUpperCase();
            
            // Varre base ST (Descrição index 4)
            for (let row of DB_ST) {
                // Proteção contra linhas vazias ou mal formatadas
                if (!row[4]) continue; 
                const keywords = row[4].toUpperCase().split(' ').filter(w => w.length > 3 && !['PARA', 'QUALQUER'].includes(w));
                if (keywords.some(k => cleanDesc.includes(k))) return { ncm: row[3], desc: row[4] };
                if (cleanDesc.includes("PICOLE") && row[4].toUpperCase().includes("SORVETE")) return { ncm: "2105", desc: "Sorvetes e Picolés" };
            }
            // Varre Federal (Descrição index 2)
            for (let row of DB_FEDERAL) {
                if (!row[2]) continue;
                if(row[2].toUpperCase().includes("REFRIGERANTE") && cleanDesc.includes("REFRIGERANTE")) return { ncm: row[1], desc: row[2] };
            }
            return null;
        }

        // --- UI & OUTROS ---
        function updateDashboard() {
            document.getElementById('dash-xmls').innerText = "1"; 
            document.getElementById('dash-products').innerText = xmlItems.length.toLocaleString();
            document.getElementById('dash-ncm-errors').innerText = xmlItems.filter(i => i.ncmError).length;
            document.getElementById('dash-cst-errors').innerText = xmlItems.filter(i => i.status === 'error' && !i.ncmError).length;
            const recovery = xmlItems.reduce((acc, i) => acc + i.potentialRecovery, 0);
            document.getElementById('dash-recovery').innerText = recovery.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            const tbody = document.getElementById('audit-body');
            tbody.innerHTML = '';
            
            xmlItems.slice(0, 150).forEach(item => {
                let badge = '<span class="status-badge bg-slate-700 text-slate-400">OK</span>';
                if (item.ncmError) badge = '<span class="status-badge status-danger">ERRO NCM</span>';
                else if (item.status === 'error') badge = '<span class="status-badge status-danger">RISCO</span>';
                else if (item.status === 'warning') badge = '<span class="status-badge status-warning">ALERTA</span>';

                const row = document.createElement('tr');
                row.className = "hover:bg-slate-800 border-b border-slate-700/50 transition";
                row.innerHTML = `
                    <td class="p-4 text-center align-top">${badge}</td>
                    <td class="p-4 align-top">
                        <div class="font-bold text-white text-xs">${item.xProd}</div>
                        <div class="text-[9px] text-slate-500 mt-1">R$ ${item.vProd.toFixed(2)}</div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] ${item.ncmError ? 'text-danger font-bold' : 'text-slate-400'} bg-slate-900 px-2 py-1 rounded w-fit font-mono">NCM: ${item.ncm}</span>
                            <span class="text-[10px] text-slate-400 bg-slate-900 px-2 py-1 rounded w-fit font-mono">CST: ${item.cst}</span>
                        </div>
                    </td>
                    <td class="p-4 text-xs text-slate-300 leading-relaxed align-top">
                        ${item.analysis.length > 0 ? item.analysis.join('<div class="h-2"></div>') : '<span class="text-slate-600 italic">Conformidade verificada.</span>'}
                    </td>
                    <td class="p-4 text-center align-top">
                        ${item.newCst || item.ncmError ? `<button onclick="this.innerHTML='<i class=\\'fa-solid fa-check\\'></i> Aplicado'; this.className='text-success text-xs font-bold'" class="bg-primary hover:bg-orange-600 text-black px-3 py-1 rounded text-[10px] font-bold uppercase shadow-lg shadow-orange-900/20 transition w-full">Aplicar Correção</button>` : '-'}
                    </td>
                `;
                tbody.appendChild(row);
            });

            const total = xmlItems.reduce((acc, i) => acc + i.vProd, 0);
            document.getElementById('pgdas-xml-val').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('pgdas-xml-val').dataset.val = total;
        }

        function switchTab(tabId) {
            ['dashboard', 'audit', 'pgdas', 'library'].forEach(id => document.getElementById('tab-' + id).classList.add('hidden-tab'));
            document.getElementById('tab-' + tabId).classList.remove('hidden-tab');
            const actions = document.getElementById('audit-actions');
            tabId === 'audit' || tabId === 'dashboard' ? actions.classList.remove('hidden-tab') : actions.classList.add('hidden-tab');
            const titles = {'dashboard': 'Dashboard Gerencial', 'audit': 'Auditoria de XML', 'pgdas': 'Conferência PGDAS', 'library': 'Base Legal Integrada'};
            document.getElementById('page-title').innerText = titles[tabId];
        }

        function switchLibrary(type) {
            switchTab('library');
            activeLibrary = type;
            const badge = document.getElementById('lib-badge');
            badge.innerText = type === 'federal' ? 'FEDERAL' : (type === 'st' ? 'ESTADUAL ST' : 'BENEFÍCIOS SP');
            badge.className = `bg-slate-800 px-4 py-2 rounded text-xs font-bold text-white border flex items-center uppercase ${type === 'federal' ? 'border-primary text-primary' : (type === 'st' ? 'border-accent text-accent' : 'border-success text-success')}`;
            filterLibrary();
        }

        function filterLibrary() {
            const term = document.getElementById('lib-search').value.toLowerCase();
            const tbody = document.getElementById('lib-body');
            tbody.innerHTML = '';
            
            let source = activeLibrary === 'federal' ? DB_FEDERAL : (activeLibrary === 'st' ? DB_ST : DB_BENEFITS);
            
            // Filtro seguro
            let filtered = source.filter(row => row.some(c => c && c.toLowerCase().includes(term)));
            if(term === '') filtered = filtered.slice(0, 100);

            filtered.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800 border-b border-slate-700/50 cursor-pointer";
                tr.onclick = () => openLawModal(row);
                tr.innerHTML = row.map((cell, i) => `<td class="p-3 ${i===0?'font-bold text-white':''}">${cell}</td>`).join('');
                tbody.appendChild(tr);
            });
        }

        function openLawModal(row) {
            const modal = document.getElementById('lawModal');
            modal.classList.remove('hidden-tab');
            // Tenta pegar o último item como Fundamento
            const content = row[row.length-1] || 'Sem detalhes adicionais';
            document.getElementById('modalBody').innerHTML = `<h2 class="text-primary font-bold text-lg mb-4">${row[2] || row[1]}</h2><p class="text-justify"><strong>DISPOSITIVO LEGAL:</strong><br>${content}<br><br>Dado carregado do arquivo de origem.</p>`;
        }
        function closeModal() { document.getElementById('lawModal').classList.add('hidden-tab'); }

        function checkPgdas() {
            const xml = parseFloat(document.getElementById('pgdas-xml-val').dataset.val || 0);
            const user = parseFloat(document.getElementById('pgdas-input').value || 0);
            const diff = xml - user;
            const res = document.getElementById('pgdas-result');
            res.classList.remove('hidden-tab');
            if(diff > 0.01) res.innerHTML = `<div class="bg-danger/10 border-l-4 border-danger p-4 text-white"><h3 class="font-bold">DIVERGÊNCIA</h3><p>Faturado (R$ ${xml.toFixed(2)}) > Declarado (R$ ${user.toFixed(2)}). Diferença: <b>R$ ${diff.toFixed(2)}</b>.</p></div>`;
            else res.innerHTML = `<div class="bg-success/10 border-l-4 border-success p-4 text-white"><h3 class="font-bold">OK</h3><p>Valores conferem.</p></div>`;
        }

        function exportReport() {
            if(xmlItems.length === 0) return alert("Nada para exportar");
            const data = xmlItems.map(i => ({Produto: i.xProd, NCM: i.ncm, Valor: i.vProd, CST: i.cst, Status: i.status, Diagnostico: i.analysis.join(' | ').replace(/<[^>]*>/g, '')}));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Auditoria");
            XLSX.writeFile(wb, "Relatorio_Auditor.xlsx");
        }

        // Init
        switchTab('dashboard');
    </script>
</body>
</html>
